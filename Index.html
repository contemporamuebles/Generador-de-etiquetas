<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Generación de Etiquetas</title>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #fff8e1;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid #f0f0f0;
        }

        h1, h2, h3 {
            margin-bottom: 20px;
            text-align: center;
        }

        h1 {
            color: #333;
            border-bottom: 2px solid #fcc919;
            padding-bottom: 10px;
            font-size: 28px;
            font-weight: 700;
        }

        h2 {
            color: #444;
            font-size: 22px;
            font-weight: 600;
        }

        h3 {
            color: #555;
            font-size: 18px;
            font-weight: 600;
        }

        .button-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 25px 0;
            flex-wrap: wrap;
        }

        button {
            border: none;
            padding: 14px 28px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 200px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Botones principales con diferentes colores */
        .btn-primary {
            background-color: #fcc919;
            color: #333;
        }

        .btn-primary:hover {
            background-color: #f0bd0a;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(252, 201, 25, 0.3);
        }

        .btn-secondary {
            background-color: #5d6d7e;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #4a5a6a;
            transform: translateY(-2px);
        }

        .btn-success {
            background-color: #28b463;
            color: white;
        }

        .btn-success:hover {
            background-color: #239b56;
            transform: translateY(-2px);
        }

        .btn-info {
            background-color: #3498db;
            color: white;
        }

        .btn-info:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }

        .btn-warning {
            background-color: #e67e22;
            color: white;
        }

        .btn-warning:hover {
            background-color: #d35400;
            transform: translateY(-2px);
        }

        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
        }

        .hidden {
            display: none !important;
        }

        .table-container {
            overflow-x: auto;
            margin: 20px 0;
            border: 1px solid #eee;
            border-radius: 6px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        tr:hover {
            background-color: #f9f9f9;
        }

        input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: border 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #fcc919;
            box-shadow: 0 0 0 2px rgba(252, 201, 25, 0.2);
        }

        .file-input-container {
            margin: 20px 0;
            text-align: center;
        }

        .file-input-label {
            display: inline-block;
            background-color: #5d6d7e;
            color: white;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
        }

        .file-input-label:hover {
            background-color: #4a5a6a;
        }

        #fileInput {
            display: none;
        }

        .instructions {
            background-color: #f8f9fa;
            border-left: 4px solid #fcc919;
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 6px 6px 0;
        }

        .instructions h3 {
            margin-top: 0;
            text-align: left;
            color: #444;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            margin-top: 25px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .controls button {
            min-width: 150px;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }

        .step {
            padding: 10px 20px;
            background-color: #ecf0f1;
            margin: 0 5px;
            border-radius: 5px;
            font-weight: 600;
            color: #666;
        }

        .step.active {
            background-color: #fcc919;
            color: #333;
            font-weight: 700;
        }

        @media (max-width: 768px) {
            .button-group {
                flex-direction: column;
                align-items: center;
            }
            
            button {
                width: 100%;
                max-width: 300px;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .controls button {
                width: 100%;
                max-width: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🏷️ Sistema de Generación de Etiquetas</h1>
        
        <!-- Pantalla principal -->
        <div id="mainScreen">
            <h2>Seleccione el tipo de etiquetas a generar</h2>
            <div class="button-group">
                <button id="stoneBtn" class="btn-primary">1. Etiquetas para Placas de Piedra</button>
                <button id="furnitureBtn" class="btn-info">2. Etiquetas para Muebles</button>
            </div>
            
            <div class="instructions">
                <h3>📋 Instrucciones:</h3>
                <p>1. Seleccione el tipo de etiquetas que desea generar.</p>
                <p>2. Puede pegar datos directamente desde Excel manteniendo el orden de columnas.</p>
                <p>3. También puede importar un archivo Excel para autocompletar la tabla.</p>
                <p>4. Las etiquetas se generarán en formato PDF listo para imprimir.</p>
            </div>
        </div>
        
        <!-- Pantalla para placas de piedra -->
        <div id="stoneScreen" class="hidden">
            <div class="step-indicator">
                <div class="step active">Placas de Piedra</div>
            </div>
            
            <h2>🏔️ Etiquetas para Placas de Piedra</h2>
            
            <div class="instructions">
                <h3>📏 Especificaciones:</h3>
                <p>- Tamaño de etiqueta: 7.43 cm (alto) × 1.31 cm (ancho)</p>
                <p>- Texto en orientación vertical</p>
                <p>- Cada etiqueta mostrará código de barras, clave y nombre</p>
                <p>- Puede pegar datos desde Excel en el orden: Clave, Nombre, Cantidad</p>
            </div>
            
            <div class="file-input-container">
                <label for="stoneFileInput" class="file-input-label">
                    📁 Importar datos desde Excel
                </label>
                <input type="file" id="stoneFileInput" accept=".xlsx,.xls,.csv">
            </div>
            
            <div class="table-container">
                <table id="stoneTable">
                    <thead>
                        <tr>
                            <th>Clave de la Placa</th>
                            <th>Nombre de la Placa</th>
                            <th>Cantidad de Etiquetas</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="stoneTableBody">
                        <tr>
                            <td><input type="text" class="stone-clave" placeholder="Ej: PLACA001"></td>
                            <td><input type="text" class="stone-nombre" placeholder="Ej: Mármol Blanco"></td>
                            <td><input type="number" class="stone-cantidad" min="1" value="1"></td>
                            <td><button class="btn-danger remove-row">Eliminar</button></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="controls">
                <button id="addStoneRow" class="btn-success">+ Agregar Fila</button>
                <button id="generateStoneLabels" class="btn-primary">Generar Etiquetas</button>
                <button id="backFromStone" class="btn-secondary">← Volver al Inicio</button>
            </div>
        </div>
        
        <!-- Pantalla para muebles - Selección con/sin clave -->
        <div id="furnitureKeyScreen" class="hidden">
            <div class="step-indicator">
                <div class="step active">Muebles → Tipo de Etiqueta</div>
            </div>
            
            <h2>🛋️ Etiquetas para Muebles</h2>
            <p>Seleccione el tipo de etiqueta:</p>
            
            <div class="button-group">
                <button id="withKeyBtn" class="btn-primary">a) Etiquetas con Clave</button>
                <button id="withoutKeyBtn" class="btn-warning">b) Etiquetas sin Clave</button>
                <button id="backFromFurnitureKey" class="btn-secondary">← Volver</button>
            </div>
        </div>
        
        <!-- Pantalla para muebles - Selección piezas -->
        <div id="furniturePiecesScreen" class="hidden">
            <div class="step-indicator">
                <div class="step">Muebles → Tipo de Etiqueta</div>
                <div class="step active">→ Varias/Una Pieza</div>
            </div>
            
            <h2 id="furnitureTypeTitle">🛋️ Etiquetas para Muebles</h2>
            <p>¿Desea etiquetas para varias piezas o una pieza?</p>
            
            <div class="button-group">
                <button id="multiplePiecesBtn" class="btn-success">Varias Piezas</button>
                <button id="singlePieceBtn" class="btn-info">Una Pieza</button>
                <button id="backFromFurniturePieces" class="btn-secondary">← Volver</button>
            </div>
        </div>
        
        <!-- Pantalla para muebles con clave y varias piezas -->
        <div id="furnitureWithKeyMultipleScreen" class="hidden">
            <div class="step-indicator">
                <div class="step">Muebles → Con Clave</div>
                <div class="step active">→ Varias Piezas</div>
            </div>
            
            <h2>🏷️ Etiquetas para Muebles (Con Clave - Varias Piezas)</h2>
            
            <div class="instructions">
                <h3>📋 Instrucciones:</h3>
                <p>- Complete la tabla con los datos requeridos</p>
                <p>- La primera etiqueta de cada artículo incluirá un * para indicar pieza principal</p>
                <p>- Se generará el recuento de piezas (Ej: 1 de 3, 2 de 3, 3 de 3)</p>
                <p>- Puede pegar datos desde Excel en el orden: Clave, Nombre, N° Etiquetas, N° Piezas</p>
            </div>
            
            <div class="file-input-container">
                <label for="furnitureFileInput" class="file-input-label">
                    📁 Importar datos desde Excel
                </label>
                <input type="file" id="furnitureFileInput" accept=".xlsx,.xls,.csv">
            </div>
            
            <div class="table-container">
                <table id="furnitureWithKeyMultipleTable">
                    <thead>
                        <tr>
                            <th>Clave del Artículo</th>
                            <th>Nombre del Artículo</th>
                            <th>N° de Etiquetas</th>
                            <th>N° de Piezas</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="furnitureWithKeyMultipleBody">
                        <tr>
                            <td><input type="text" class="furniture-clave" placeholder="Ej: MUEBLE001"></td>
                            <td><input type="text" class="furniture-nombre" placeholder="Ej: Cama King Size"></td>
                            <td><input type="number" class="furniture-etiquetas" min="1" value="1"></td>
                            <td><input type="number" class="furniture-piezas" min="1" value="1"></td>
                            <td><button class="btn-danger remove-row">Eliminar</button></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="controls">
                <button id="addFurnitureWithKeyMultipleRow" class="btn-success">+ Agregar Fila</button>
                <button id="generateFurnitureWithKeyMultiple" class="btn-primary">Generar Etiquetas</button>
                <button id="backFromFurnitureWithKeyMultiple" class="btn-secondary">← Volver</button>
            </div>
        </div>
        
        <!-- Pantalla para muebles con clave y una pieza -->
        <div id="furnitureWithKeySingleScreen" class="hidden">
            <div class="step-indicator">
                <div class="step">Muebles → Con Clave</div>
                <div class="step active">→ Una Pieza</div>
            </div>
            
            <h2>🏷️ Etiquetas para Muebles (Con Clave - Una Pieza)</h2>
            
            <div class="instructions">
                <h3>📋 Instrucciones:</h3>
                <p>- Complete la tabla con los datos requeridos</p>
                <p>- Cada etiqueta incluirá: Nombre, Clave y Código de Barras</p>
                <p>- Puede pegar datos desde Excel en el orden: Clave, Nombre, N° Etiquetas</p>
            </div>
            
            <div class="file-input-container">
                <label for="furnitureSingleFileInput" class="file-input-label">
                    📁 Importar datos desde Excel
                </label>
                <input type="file" id="furnitureSingleFileInput" accept=".xlsx,.xls,.csv">
            </div>
            
            <div class="table-container">
                <table id="furnitureWithKeySingleTable">
                    <thead>
                        <tr>
                            <th>Clave del Artículo</th>
                            <th>Nombre del Artículo</th>
                            <th>N° de Etiquetas</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="furnitureWithKeySingleBody">
                        <tr>
                            <td><input type="text" class="furniture-clave-single" placeholder="Ej: MUEBLE001"></td>
                            <td><input type="text" class="furniture-nombre-single" placeholder="Ej: Cama King Size"></td>
                            <td><input type="number" class="furniture-etiquetas-single" min="1" value="1"></td>
                            <td><button class="btn-danger remove-row">Eliminar</button></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="controls">
                <button id="addFurnitureWithKeySingleRow" class="btn-success">+ Agregar Fila</button>
                <button id="generateFurnitureWithKeySingle" class="btn-primary">Generar Etiquetas</button>
                <button id="backFromFurnitureWithKeySingle" class="btn-secondary">← Volver</button>
            </div>
        </div>
        
        <!-- Pantalla para muebles sin clave y varias piezas -->
        <div id="furnitureWithoutKeyMultipleScreen" class="hidden">
            <div class="step-indicator">
                <div class="step">Muebles → Sin Clave</div>
                <div class="step active">→ Varias Piezas</div>
            </div>
            
            <h2>🏷️ Etiquetas para Muebles (Sin Clave - Varias Piezas)</h2>
            
            <div class="instructions">
                <h3>📋 Instrucciones:</h3>
                <p>- Complete la tabla con los datos requeridos</p>
                <p>- Se generará el recuento de piezas (Ej: 1 de 3, 2 de 3, 3 de 3)</p>
                <p>- Puede pegar datos desde Excel en el orden: Nombre, N° Etiquetas, N° Piezas</p>
            </div>
            
            <div class="file-input-container">
                <label for="furnitureWithoutKeyFileInput" class="file-input-label">
                    📁 Importar datos desde Excel
                </label>
                <input type="file" id="furnitureWithoutKeyFileInput" accept=".xlsx,.xls,.csv">
            </div>
            
            <div class="table-container">
                <table id="furnitureWithoutKeyMultipleTable">
                    <thead>
                        <tr>
                            <th>Nombre del Artículo</th>
                            <th>N° de Etiquetas</th>
                            <th>N° de Piezas</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="furnitureWithoutKeyMultipleBody">
                        <tr>
                            <td><input type="text" class="furniture-nombre-nokey" placeholder="Ej: Cama King Size"></td>
                            <td><input type="number" class="furniture-etiquetas-nokey" min="1" value="1"></td>
                            <td><input type="number" class="furniture-piezas-nokey" min="1" value="1"></td>
                            <td><button class="btn-danger remove-row">Eliminar</button></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="controls">
                <button id="addFurnitureWithoutKeyMultipleRow" class="btn-success">+ Agregar Fila</button>
                <button id="generateFurnitureWithoutKeyMultiple" class="btn-warning">Generar Etiquetas</button>
                <button id="backFromFurnitureWithoutKeyMultiple" class="btn-secondary">← Volver</button>
            </div>
        </div>
        
        <!-- Pantalla para muebles sin clave y una pieza -->
        <div id="furnitureWithoutKeySingleScreen" class="hidden">
            <div class="step-indicator">
                <div class="step">Muebles → Sin Clave</div>
                <div class="step active">→ Una Pieza</div>
            </div>
            
            <h2>🏷️ Etiquetas para Muebles (Sin Clave - Una Pieza)</h2>
            
            <div class="instructions">
                <h3>📋 Instrucciones:</h3>
                <p>- Complete la tabla con los datos requeridos</p>
                <p>- Cada etiqueta incluirá solo el nombre del artículo</p>
                <p>- Puede pegar datos desde Excel en el orden: Nombre, N° Etiquetas</p>
            </div>
            
            <div class="file-input-container">
                <label for="furnitureWithoutKeySingleFileInput" class="file-input-label">
                    📁 Importar datos desde Excel
                </label>
                <input type="file" id="furnitureWithoutKeySingleFileInput" accept=".xlsx,.xls,.csv">
            </div>
            
            <div class="table-container">
                <table id="furnitureWithoutKeySingleTable">
                    <thead>
                        <tr>
                            <th>Nombre del Artículo</th>
                            <th>N° de Etiquetas</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="furnitureWithoutKeySingleBody">
                        <tr>
                            <td><input type="text" class="furniture-nombre-nokey-single" placeholder="Ej: Cama King Size"></td>
                            <td><input type="number" class="furniture-etiquetas-nokey-single" min="1" value="1"></td>
                            <td><button class="btn-danger remove-row">Eliminar</button></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="controls">
                <button id="addFurnitureWithoutKeySingleRow" class="btn-success">+ Agregar Fila</button>
                <button id="generateFurnitureWithoutKeySingle" class="btn-warning">Generar Etiquetas</button>
                <button id="backFromFurnitureWithoutKeySingle" class="btn-secondary">← Volver</button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let currentFurnitureType = '';
        let currentPiecesType = '';
        
        // Inicialización de eventos
        document.addEventListener('DOMContentLoaded', function() {
            // Botones principales
            document.getElementById('stoneBtn').addEventListener('click', showStoneScreen);
            document.getElementById('furnitureBtn').addEventListener('click', showFurnitureKeyScreen);
            
            // Botones de navegación para piedra
            document.getElementById('backFromStone').addEventListener('click', showMainScreen);
            document.getElementById('addStoneRow').addEventListener('click', addStoneRow);
            document.getElementById('generateStoneLabels').addEventListener('click', generateStoneLabels);
            
            // Botones para muebles - selección de clave
            document.getElementById('withKeyBtn').addEventListener('click', () => showFurniturePiecesScreen('withKey'));
            document.getElementById('withoutKeyBtn').addEventListener('click', () => showFurniturePiecesScreen('withoutKey'));
            document.getElementById('backFromFurnitureKey').addEventListener('click', showMainScreen);
            
            // Botones para muebles - selección de piezas
            document.getElementById('multiplePiecesBtn').addEventListener('click', showFurnitureScreen);
            document.getElementById('singlePieceBtn').addEventListener('click', showFurnitureScreen);
            document.getElementById('backFromFurniturePieces').addEventListener('click', showFurnitureKeyScreen);
            
            // Botones para muebles con clave y varias piezas
            document.getElementById('addFurnitureWithKeyMultipleRow').addEventListener('click', () => addFurnitureRow('withKeyMultiple'));
            document.getElementById('generateFurnitureWithKeyMultiple').addEventListener('click', () => generateFurnitureLabels('withKeyMultiple'));
            document.getElementById('backFromFurnitureWithKeyMultiple').addEventListener('click', showFurniturePiecesScreenFromSubscreen);
            
            // Botones para muebles con clave y una pieza
            document.getElementById('addFurnitureWithKeySingleRow').addEventListener('click', () => addFurnitureRow('withKeySingle'));
            document.getElementById('generateFurnitureWithKeySingle').addEventListener('click', () => generateFurnitureLabels('withKeySingle'));
            document.getElementById('backFromFurnitureWithKeySingle').addEventListener('click', showFurniturePiecesScreenFromSubscreen);
            
            // Botones para muebles sin clave y varias piezas
            document.getElementById('addFurnitureWithoutKeyMultipleRow').addEventListener('click', () => addFurnitureRow('withoutKeyMultiple'));
            document.getElementById('generateFurnitureWithoutKeyMultiple').addEventListener('click', () => generateFurnitureLabels('withoutKeyMultiple'));
            document.getElementById('backFromFurnitureWithoutKeyMultiple').addEventListener('click', showFurniturePiecesScreenFromSubscreen);
            
            // Botones para muebles sin clave y una pieza
            document.getElementById('addFurnitureWithoutKeySingleRow').addEventListener('click', () => addFurnitureRow('withoutKeySingle'));
            document.getElementById('generateFurnitureWithoutKeySingle').addEventListener('click', () => generateFurnitureLabels('withoutKeySingle'));
            document.getElementById('backFromFurnitureWithoutKeySingle').addEventListener('click', showFurniturePiecesScreenFromSubscreen);
            
            // Eventos para eliminar filas (delegación de eventos)
            document.addEventListener('click', function(e) {
                if (e.target && e.target.classList.contains('remove-row')) {
                    const row = e.target.closest('tr');
                    if (row && row.parentElement.querySelectorAll('tr').length > 1) {
                        row.remove();
                    }
                }
            });
            
            // Eventos para pegar desde Excel
            document.addEventListener('paste', handlePaste);
            
            // Eventos para importar archivos Excel
            document.getElementById('stoneFileInput').addEventListener('change', handleStoneFileImport);
            document.getElementById('furnitureFileInput').addEventListener('change', (e) => handleFurnitureFileImport(e, 'withKeyMultiple'));
            document.getElementById('furnitureSingleFileInput').addEventListener('change', (e) => handleFurnitureFileImport(e, 'withKeySingle'));
            document.getElementById('furnitureWithoutKeyFileInput').addEventListener('change', (e) => handleFurnitureFileImport(e, 'withoutKeyMultiple'));
            document.getElementById('furnitureWithoutKeySingleFileInput').addEventListener('change', (e) => handleFurnitureFileImport(e, 'withoutKeySingle'));
        });
        
        // Funciones de navegación
        function showMainScreen() {
            hideAllScreens();
            document.getElementById('mainScreen').classList.remove('hidden');
        }
        
        function showStoneScreen() {
            hideAllScreens();
            document.getElementById('stoneScreen').classList.remove('hidden');
        }
        
        function showFurnitureKeyScreen() {
            hideAllScreens();
            document.getElementById('furnitureKeyScreen').classList.remove('hidden');
        }
        
        function showFurniturePiecesScreen(type) {
            currentFurnitureType = type;
            hideAllScreens();
            document.getElementById('furniturePiecesScreen').classList.remove('hidden');
            document.getElementById('furnitureTypeTitle').textContent = 
                type === 'withKey' ? '🛋️ Etiquetas para Muebles (Con Clave)' : '🛋️ Etiquetas para Muebles (Sin Clave)';
        }
        
        function showFurniturePiecesScreenFromSubscreen() {
            showFurniturePiecesScreen(currentFurnitureType);
        }
        
        function showFurnitureScreen() {
            const buttonId = event.target.id;
            
            if (buttonId === 'multiplePiecesBtn') {
                currentPiecesType = 'multiple';
            } else if (buttonId === 'singlePieceBtn') {
                currentPiecesType = 'single';
            }
            
            let screenId = '';
            if (currentFurnitureType === 'withKey' && currentPiecesType === 'multiple') {
                screenId = 'furnitureWithKeyMultipleScreen';
            } else if (currentFurnitureType === 'withKey' && currentPiecesType === 'single') {
                screenId = 'furnitureWithKeySingleScreen';
            } else if (currentFurnitureType === 'withoutKey' && currentPiecesType === 'multiple') {
                screenId = 'furnitureWithoutKeyMultipleScreen';
            } else if (currentFurnitureType === 'withoutKey' && currentPiecesType === 'single') {
                screenId = 'furnitureWithoutKeySingleScreen';
            }
            
            hideAllScreens();
            document.getElementById(screenId).classList.remove('hidden');
        }
        
        function hideAllScreens() {
            const screens = [
                'mainScreen', 'stoneScreen', 'furnitureKeyScreen', 'furniturePiecesScreen',
                'furnitureWithKeyMultipleScreen', 'furnitureWithKeySingleScreen',
                'furnitureWithoutKeyMultipleScreen', 'furnitureWithoutKeySingleScreen'
            ];
            
            screens.forEach(screenId => {
                document.getElementById(screenId).classList.add('hidden');
            });
        }
        
        // Funciones para manejar tablas
        function addStoneRow() {
            const tbody = document.getElementById('stoneTableBody');
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td><input type="text" class="stone-clave" placeholder="Ej: PLACA001"></td>
                <td><input type="text" class="stone-nombre" placeholder="Ej: Mármol Blanco"></td>
                <td><input type="number" class="stone-cantidad" min="1" value="1"></td>
                <td><button class="btn-danger remove-row">Eliminar</button></td>
            `;
            tbody.appendChild(newRow);
        }
        
        function addFurnitureRow(type) {
            let tbodyId = '';
            let html = '';
            
            switch(type) {
                case 'withKeyMultiple':
                    tbodyId = 'furnitureWithKeyMultipleBody';
                    html = `
                        <td><input type="text" class="furniture-clave" placeholder="Ej: MUEBLE001"></td>
                        <td><input type="text" class="furniture-nombre" placeholder="Ej: Cama King Size"></td>
                        <td><input type="number" class="furniture-etiquetas" min="1" value="1"></td>
                        <td><input type="number" class="furniture-piezas" min="1" value="1"></td>
                        <td><button class="btn-danger remove-row">Eliminar</button></td>
                    `;
                    break;
                case 'withKeySingle':
                    tbodyId = 'furnitureWithKeySingleBody';
                    html = `
                        <td><input type="text" class="furniture-clave-single" placeholder="Ej: MUEBLE001"></td>
                        <td><input type="text" class="furniture-nombre-single" placeholder="Ej: Cama King Size"></td>
                        <td><input type="number" class="furniture-etiquetas-single" min="1" value="1"></td>
                        <td><button class="btn-danger remove-row">Eliminar</button></td>
                    `;
                    break;
                case 'withoutKeyMultiple':
                    tbodyId = 'furnitureWithoutKeyMultipleBody';
                    html = `
                        <td><input type="text" class="furniture-nombre-nokey" placeholder="Ej: Cama King Size"></td>
                        <td><input type="number" class="furniture-etiquetas-nokey" min="1" value="1"></td>
                        <td><input type="number" class="furniture-piezas-nokey" min="1" value="1"></td>
                        <td><button class="btn-danger remove-row">Eliminar</button></td>
                    `;
                    break;
                case 'withoutKeySingle':
                    tbodyId = 'furnitureWithoutKeySingleBody';
                    html = `
                        <td><input type="text" class="furniture-nombre-nokey-single" placeholder="Ej: Cama King Size"></td>
                        <td><input type="number" class="furniture-etiquetas-nokey-single" min="1" value="1"></td>
                        <td><button class="btn-danger remove-row">Eliminar</button></td>
                    `;
                    break;
            }
            
            const tbody = document.getElementById(tbodyId);
            const newRow = document.createElement('tr');
            newRow.innerHTML = html;
            tbody.appendChild(newRow);
        }
        
        // Función para manejar pegado desde Excel
        function handlePaste(event) {
            const activeElement = document.activeElement;
            const isInput = activeElement.tagName === 'INPUT';
            
            if (!isInput) {
                event.preventDefault();
                const clipboardData = event.clipboardData || window.clipboardData;
                const pastedData = clipboardData.getData('Text');
                
                let screen = '';
                if (!document.getElementById('stoneScreen').classList.contains('hidden')) {
                    screen = 'stone';
                } else if (!document.getElementById('furnitureWithKeyMultipleScreen').classList.contains('hidden')) {
                    screen = 'furnitureWithKeyMultiple';
                } else if (!document.getElementById('furnitureWithKeySingleScreen').classList.contains('hidden')) {
                    screen = 'furnitureWithKeySingle';
                } else if (!document.getElementById('furnitureWithoutKeyMultipleScreen').classList.contains('hidden')) {
                    screen = 'furnitureWithoutKeyMultiple';
                } else if (!document.getElementById('furnitureWithoutKeySingleScreen').classList.contains('hidden')) {
                    screen = 'furnitureWithoutKeySingle';
                }
                
                if (screen) {
                    processPastedData(pastedData, screen);
                }
            }
        }
        
        function processPastedData(data, screen) {
            const rows = data.split('\n').filter(row => row.trim() !== '');
            
            let tbody;
            let rowTemplate;
            let columns;
            
            switch(screen) {
                case 'stone':
                    tbody = document.getElementById('stoneTableBody');
                    rowTemplate = `<tr>
                        <td><input type="text" class="stone-clave"></td>
                        <td><input type="text" class="stone-nombre"></td>
                        <td><input type="number" class="stone-cantidad" min="1" value="1"></td>
                        <td><button class="btn-danger remove-row">Eliminar</button></td>
                    </tr>`;
                    columns = 3;
                    break;
                case 'furnitureWithKeyMultiple':
                    tbody = document.getElementById('furnitureWithKeyMultipleBody');
                    rowTemplate = `<tr>
                        <td><input type="text" class="furniture-clave"></td>
                        <td><input type="text" class="furniture-nombre"></td>
                        <td><input type="number" class="furniture-etiquetas" min="1" value="1"></td>
                        <td><input type="number" class="furniture-piezas" min="1" value="1"></td>
                        <td><button class="btn-danger remove-row">Eliminar</button></td>
                    </tr>`;
                    columns = 4;
                    break;
                case 'furnitureWithKeySingle':
                    tbody = document.getElementById('furnitureWithKeySingleBody');
                    rowTemplate = `<tr>
                        <td><input type="text" class="furniture-clave-single"></td>
                        <td><input type="text" class="furniture-nombre-single"></td>
                        <td><input type="number" class="furniture-etiquetas-single" min="1" value="1"></td>
                        <td><button class="btn-danger remove-row">Eliminar</button></td>
                    </tr>`;
                    columns = 3;
                    break;
                case 'furnitureWithoutKeyMultiple':
                    tbody = document.getElementById('furnitureWithoutKeyMultipleBody');
                    rowTemplate = `<tr>
                        <td><input type="text" class="furniture-nombre-nokey"></td>
                        <td><input type="number" class="furniture-etiquetas-nokey" min="1" value="1"></td>
                        <td><input type="number" class="furniture-piezas-nokey" min="1" value="1"></td>
                        <td><button class="btn-danger remove-row">Eliminar</button></td>
                    </tr>`;
                    columns = 3;
                    break;
                case 'furnitureWithoutKeySingle':
                    tbody = document.getElementById('furnitureWithoutKeySingleBody');
                    rowTemplate = `<tr>
                        <td><input type="text" class="furniture-nombre-nokey-single"></td>
                        <td><input type="number" class="furniture-etiquetas-nokey-single" min="1" value="1"></td>
                        <td><button class="btn-danger remove-row">Eliminar</button></td>
                    </tr>`;
                    columns = 2;
                    break;
            }
            
            // Limpiar tabla (dejar solo la primera fila)
            while (tbody.children.length > 1) {
                tbody.removeChild(tbody.lastChild);
            }
            
            // Procesar cada fila pegada
            rows.forEach((row, rowIndex) => {
                const cells = row.split('\t');
                
                if (rowIndex === 0 && cells.length > 0) {
                    // Primera fila (actual)
                    const firstRow = tbody.children[0];
                    const inputs = firstRow.querySelectorAll('input');
                    
                    cells.forEach((cell, cellIndex) => {
                        if (cellIndex < inputs.length) {
                            inputs[cellIndex].value = cell.trim();
                        }
                    });
                } else if (cells.length > 0) {
                    // Filas adicionales
                    const newRow = document.createElement('tr');
                    newRow.innerHTML = rowTemplate;
                    tbody.appendChild(newRow);
                    
                    const inputs = newRow.querySelectorAll('input');
                    cells.forEach((cell, cellIndex) => {
                        if (cellIndex < inputs.length) {
                            inputs[cellIndex].value = cell.trim();
                        }
                    });
                }
            });
        }
        
        // Función para importar archivos Excel
        function handleStoneFileImport(event) {
            handleFileImport(event, 'stone');
        }
        
        function handleFurnitureFileImport(event, type) {
            handleFileImport(event, type);
        }
        
        function handleFileImport(event, type) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const sheetData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                
                processImportedData(sheetData, type);
            };
            reader.readAsArrayBuffer(file);
        }
        
        function processImportedData(data, type) {
            const rows = data.filter(row => row.some(cell => cell !== null && cell !== ''));
            
            let tbody;
            let rowTemplate;
            let columnCount;
            
            switch(type) {
                case 'stone':
                    tbody = document.getElementById('stoneTableBody');
                    rowTemplate = `<tr>
                        <td><input type="text" class="stone-clave"></td>
                        <td><input type="text" class="stone-nombre"></td>
                        <td><input type="number" class="stone-cantidad" min="1" value="1"></td>
                        <td><button class="btn-danger remove-row">Eliminar</button></td>
                    </tr>`;
                    columnCount = 3;
                    break;
                case 'withKeyMultiple':
                    tbody = document.getElementById('furnitureWithKeyMultipleBody');
                    rowTemplate = `<tr>
                        <td><input type="text" class="furniture-clave"></td>
                        <td><input type="text" class="furniture-nombre"></td>
                        <td><input type="number" class="furniture-etiquetas" min="1" value="1"></td>
                        <td><input type="number" class="furniture-piezas" min="1" value="1"></td>
                        <td><button class="btn-danger remove-row">Eliminar</button></td>
                    </tr>`;
                    columnCount = 4;
                    break;
                case 'withKeySingle':
                    tbody = document.getElementById('furnitureWithKeySingleBody');
                    rowTemplate = `<tr>
                        <td><input type="text" class="furniture-clave-single"></td>
                        <td><input type="text" class="furniture-nombre-single"></td>
                        <td><input type="number" class="furniture-etiquetas-single" min="1" value="1"></td>
                        <td><button class="btn-danger remove-row">Eliminar</button></td>
                    </tr>`;
                    columnCount = 3;
                    break;
                case 'withoutKeyMultiple':
                    tbody = document.getElementById('furnitureWithoutKeyMultipleBody');
                    rowTemplate = `<tr>
                        <td><input type="text" class="furniture-nombre-nokey"></td>
                        <td><input type="number" class="furniture-etiquetas-nokey" min="1" value="1"></td>
                        <td><input type="number" class="furniture-piezas-nokey" min="1" value="1"></td>
                        <td><button class="btn-danger remove-row">Eliminar</button></td>
                    </tr>`;
                    columnCount = 3;
                    break;
                case 'withoutKeySingle':
                    tbody = document.getElementById('furnitureWithoutKeySingleBody');
                    rowTemplate = `<tr>
                        <td><input type="text" class="furniture-nombre-nokey-single"></td>
                        <td><input type="number" class="furniture-etiquetas-nokey-single" min="1" value="1"></td>
                        <td><button class="btn-danger remove-row">Eliminar</button></td>
                    </tr>`;
                    columnCount = 2;
                    break;
            }
            
            while (tbody.children.length > 1) {
                tbody.removeChild(tbody.lastChild);
            }
            
            rows.forEach((row, rowIndex) => {
                if (rowIndex === 0) {
                    const firstRow = tbody.children[0];
                    const inputs = firstRow.querySelectorAll('input');
                    
                    row.forEach((cell, cellIndex) => {
                        if (cellIndex < inputs.length) {
                            inputs[cellIndex].value = cell !== null ? String(cell).trim() : '';
                        }
                    });
                } else {
                    const newRow = document.createElement('tr');
                    newRow.innerHTML = rowTemplate;
                    tbody.appendChild(newRow);
                    
                    const inputs = newRow.querySelectorAll('input');
                    row.forEach((cell, cellIndex) => {
                        if (cellIndex < inputs.length) {
                            inputs[cellIndex].value = cell !== null ? String(cell).trim() : '';
                        }
                    });
                }
            });
            
            event.target.value = '';
        }
        
        // Función para generar etiquetas de piedra
        function generateStoneLabels() {
            const rows = document.querySelectorAll('#stoneTableBody tr');
            const labels = [];
            
            rows.forEach(row => {
                const clave = row.querySelector('.stone-clave').value.trim();
                const nombre = row.querySelector('.stone-nombre').value.trim();
                const cantidad = parseInt(row.querySelector('.stone-cantidad').value) || 0;
                
                if (clave && nombre && cantidad > 0) {
                    for (let i = 0; i < cantidad; i++) {
                        labels.push({ clave, nombre });
                    }
                }
            });
            
            if (labels.length === 0) {
                alert('Por favor, ingrese al menos una etiqueta válida.');
                return;
            }
            
            generateStonePDF(labels);
        }
        
        function generateStonePDF(labels) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'cm',
                format: 'letter'
            });
            
            const pageWidth = 21.59;
            const pageHeight = 27.94;
            const labelWidth = 1.31;
            const labelHeight = 7.43;
            
            // Margenes de impresión para etiquetas pequeñas
            const marginLeft = 0.64;
            const marginRight = 0.64;
            const marginTop = 1.15;
            const marginBottom = 1.15;
            
            const availableWidth = pageWidth - marginLeft - marginRight;
            const availableHeight = pageHeight - marginTop - marginBottom;
            
            const labelsPerRow = Math.floor(availableWidth / labelWidth);
            const labelsPerColumn = Math.floor(availableHeight / labelHeight);
            
            let currentX = marginLeft;
            let currentY = marginTop;
            let labelIndex = 0;
            
            doc.setFont("helvetica", "normal");
            
            for (let row = 0; row < labelsPerColumn; row++) {
                for (let col = 0; col < labelsPerRow; col++) {
                    if (labelIndex >= labels.length) break;
                    
                    const label = labels[labelIndex];
                    
                    // Guardar estado actual
                    doc.saveGraphicsState();
                    
                    // Trasladar el origen al centro de la etiqueta y rotar 90 grados
                    doc.translate(currentX + labelWidth/2, currentY + labelHeight/2);
                    doc.rotate(-90 * Math.PI / 180);
                    
                    // Ahora trabajamos en coordenadas rotadas
                    const rotatedWidth = labelHeight;
                    const rotatedHeight = labelWidth;
                    
                    // Dividir el espacio verticalmente
                    const sectionHeight = rotatedHeight / 3;
                    
                    // 1. Código de barras (parte superior)
                    const barcodeY = -rotatedHeight/2 + sectionHeight * 0.5;
                    doc.setFontSize(6);
                    doc.text(`*${label.clave}*`, 0, barcodeY, { align: 'center' });
                    
                    // 2. Clave (parte central)
                    const claveY = -rotatedHeight/2 + sectionHeight * 1.5;
                    doc.setFontSize(8);
                    doc.setFont(undefined, 'bold');
                    doc.text(label.clave, 0, claveY, { align: 'center' });
                    
                    // 3. Nombre (parte inferior)
                    const nameY = -rotatedHeight/2 + sectionHeight * 2.5;
                    doc.setFontSize(7);
                    doc.text(label.nombre, 0, nameY, { 
                        align: 'center', 
                        maxWidth: rotatedWidth - 0.2 
                    });
                    
                    // Restaurar estado
                    doc.restoreGraphicsState();
                    
                    // Dibujar bordes punteados
                    doc.setDrawColor(200, 200, 200);
                    doc.setLineWidth(0.01);
                    const dashPattern = [0.1, 0.1];
                    doc.setLineDashPattern(dashPattern, 0);
                    doc.rect(currentX, currentY, labelWidth, labelHeight, 'S');
                    doc.setLineDashPattern([], 0);
                    
                    currentX += labelWidth;
                    labelIndex++;
                }
                
                currentX = marginLeft;
                currentY += labelHeight;
                
                if (labelIndex >= labels.length) break;
            }
            
            // Si hay más etiquetas, agregar nuevas páginas
            while (labelIndex < labels.length) {
                doc.addPage();
                currentX = marginLeft;
                currentY = marginTop;
                
                for (let row = 0; row < labelsPerColumn; row++) {
                    for (let col = 0; col < labelsPerRow; col++) {
                        if (labelIndex >= labels.length) break;
                        
                        const label = labels[labelIndex];
                        
                        doc.saveGraphicsState();
                        doc.translate(currentX + labelWidth/2, currentY + labelHeight/2);
                        doc.rotate(-90 * Math.PI / 180);
                        
                        const rotatedWidth = labelHeight;
                        const rotatedHeight = labelWidth;
                        const sectionHeight = rotatedHeight / 3;
                        
                        const barcodeY = -rotatedHeight/2 + sectionHeight * 0.5;
                        doc.setFontSize(6);
                        doc.text(`*${label.clave}*`, 0, barcodeY, { align: 'center' });
                        
                        const claveY = -rotatedHeight/2 + sectionHeight * 1.5;
                        doc.setFontSize(8);
                        doc.setFont(undefined, 'bold');
                        doc.text(label.clave, 0, claveY, { align: 'center' });
                        
                        const nameY = -rotatedHeight/2 + sectionHeight * 2.5;
                        doc.setFontSize(7);
                        doc.text(label.nombre, 0, nameY, { 
                            align: 'center', 
                            maxWidth: rotatedWidth - 0.2 
                        });
                        
                        doc.restoreGraphicsState();
                        
                        doc.setDrawColor(200, 200, 200);
                        doc.setLineWidth(0.01);
                        const dashPattern = [0.1, 0.1];
                        doc.setLineDashPattern(dashPattern, 0);
                        doc.rect(currentX, currentY, labelWidth, labelHeight, 'S');
                        doc.setLineDashPattern([], 0);
                        
                        currentX += labelWidth;
                        labelIndex++;
                    }
                    
                    currentX = marginLeft;
                    currentY += labelHeight;
                    
                    if (labelIndex >= labels.length) break;
                }
            }
            
            doc.save('etiquetas_placas_piedra.pdf');
        }
        
        // Función para generar etiquetas de muebles
        function generateFurnitureLabels(type) {
            let labels = [];
            
            switch(type) {
                case 'withKeyMultiple':
                    labels = getFurnitureWithKeyMultipleLabels();
                    generateFurniturePDF(labels, type);
                    break;
                case 'withKeySingle':
                    labels = getFurnitureWithKeySingleLabels();
                    generateFurniturePDF(labels, type);
                    break;
                case 'withoutKeyMultiple':
                    labels = getFurnitureWithoutKeyMultipleLabels();
                    generateFurniturePDF(labels, type);
                    break;
                case 'withoutKeySingle':
                    labels = getFurnitureWithoutKeySingleLabels();
                    generateFurniturePDF(labels, type);
                    break;
            }
        }
        
        function getFurnitureWithKeyMultipleLabels() {
            const rows = document.querySelectorAll('#furnitureWithKeyMultipleBody tr');
            const labels = [];
            
            rows.forEach(row => {
                const clave = row.querySelector('.furniture-clave').value.trim();
                const nombre = row.querySelector('.furniture-nombre').value.trim();
                const etiquetas = parseInt(row.querySelector('.furniture-etiquetas').value) || 0;
                const piezas = parseInt(row.querySelector('.furniture-piezas').value) || 1;
                
                if (clave && nombre && etiquetas > 0) {
                    for (let e = 0; e < etiquetas; e++) {
                        for (let p = 1; p <= piezas; p++) {
                            const isFirstPiece = p === 1;
                            labels.push({
                                clave,
                                nombre,
                                piezaActual: p,
                                totalPiezas: piezas,
                                tieneAsterisco: isFirstPiece,
                                tieneClave: true,
                                tienePiezas: true
                            });
                        }
                    }
                }
            });
            
            return labels;
        }
        
        function getFurnitureWithKeySingleLabels() {
            const rows = document.querySelectorAll('#furnitureWithKeySingleBody tr');
            const labels = [];
            
            rows.forEach(row => {
                const clave = row.querySelector('.furniture-clave-single').value.trim();
                const nombre = row.querySelector('.furniture-nombre-single').value.trim();
                const etiquetas = parseInt(row.querySelector('.furniture-etiquetas-single').value) || 0;
                
                if (clave && nombre && etiquetas > 0) {
                    for (let i = 0; i < etiquetas; i++) {
                        labels.push({
                            clave,
                            nombre,
                            tieneClave: true,
                            tienePiezas: false
                        });
                    }
                }
            });
            
            return labels;
        }
        
        function getFurnitureWithoutKeyMultipleLabels() {
            const rows = document.querySelectorAll('#furnitureWithoutKeyMultipleBody tr');
            const labels = [];
            
            rows.forEach(row => {
                const nombre = row.querySelector('.furniture-nombre-nokey').value.trim();
                const etiquetas = parseInt(row.querySelector('.furniture-etiquetas-nokey').value) || 0;
                const piezas = parseInt(row.querySelector('.furniture-piezas-nokey').value) || 1;
                
                if (nombre && etiquetas > 0) {
                    for (let e = 0; e < etiquetas; e++) {
                        for (let p = 1; p <= piezas; p++) {
                            labels.push({
                                nombre,
                                piezaActual: p,
                                totalPiezas: piezas,
                                tieneClave: false,
                                tienePiezas: true
                            });
                        }
                    }
                }
            });
            
            return labels;
        }
        
        function getFurnitureWithoutKeySingleLabels() {
            const rows = document.querySelectorAll('#furnitureWithoutKeySingleBody tr');
            const labels = [];
            
            rows.forEach(row => {
                const nombre = row.querySelector('.furniture-nombre-nokey-single').value.trim();
                const etiquetas = parseInt(row.querySelector('.furniture-etiquetas-nokey-single').value) || 0;
                
                if (nombre && etiquetas > 0) {
                    for (let i = 0; i < etiquetas; i++) {
                        labels.push({
                            nombre,
                            tieneClave: false,
                            tienePiezas: false
                        });
                    }
                }
            });
            
            return labels;
        }
        
        function generateFurniturePDF(labels, type) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'cm',
                format: 'letter'
            });
            
            // Configuración de márgenes para media hoja
            const marginLeft = 0.64;
            const marginRight = 0.64;
            const marginTop = 1.15;
            const marginBottom = 1.15;
            
            const pageWidth = 21.59;
            const pageHeight = 27.94;
            
            // Espacio disponible para etiquetas
            const availableWidth = pageWidth - marginLeft - marginRight;
            const availableHeight = pageHeight - marginTop - marginBottom;
            
            // Dos etiquetas por hoja (media hoja cada una)
            const labelWidth = availableWidth;
            const labelHeight = availableHeight / 2;
            
            // Porcentajes de la altura de la etiqueta para cada sección
            const percentages = {
                blanco: 18.24,
                asterisco: 4.05,
                piezas: 4.05,
                barcode: 2.94,
                clave: 0.95,
                nombre: 69.78
            };
            
            // Convertir porcentajes a alturas en cm
            const sectionHeights = {};
            for (const [key, value] of Object.entries(percentages)) {
                sectionHeights[key] = (value / 100) * labelHeight;
            }
            
            let labelIndex = 0;
            let pageIndex = 0;
            
            doc.setFont("helvetica", "normal");
            
            while (labelIndex < labels.length) {
                // Verificar si necesitamos nueva página (2 etiquetas por página)
                if (labelIndex > 0 && labelIndex % 2 === 0) {
                    doc.addPage();
                    pageIndex++;
                }
                
                // Calcular la posición Y de la etiqueta actual
                const labelY = marginTop + (labelIndex % 2) * labelHeight;
                const label = labels[labelIndex];
                
                // Determinar qué elementos tiene la etiqueta
                const hasAsterisk = label.tieneAsterisco || false;
                const hasPieces = label.tienePiezas || false;
                const hasKey = label.tieneClave || false;
                
                // Ajustar alturas según los elementos que tenga
                let nombreHeight = sectionHeights.nombre;
                let currentY = labelY + sectionHeights.blanco / 2;
                
                // 1. Asterisco (si tiene)
                if (hasAsterisk) {
                    const asteriscoY = currentY + sectionHeights.asterisco / 2;
                    doc.setFontSize(14);
                    doc.setTextColor(255, 0, 0);
                    doc.text('*', marginLeft + labelWidth / 2, asteriscoY, { align: 'center' });
                    doc.setTextColor(0, 0, 0);
                    currentY += sectionHeights.asterisco;
                } else {
                    nombreHeight += sectionHeights.asterisco;
                }
                
                // 2. Nombre (ocupa el espacio restante)
                const nombreY = currentY + nombreHeight / 2;
                
                // Calcular tamaño de fuente para el nombre
                let fontSize = 36; // Tamaño inicial grande
                doc.setFont(undefined, 'bold');
                
                // Reducir tamaño hasta que quepa
                let textWidth;
                do {
                    doc.setFontSize(fontSize);
                    textWidth = doc.getTextWidth(label.nombre);
                    if (textWidth > labelWidth * 0.9 && fontSize > 8) {
                        fontSize -= 1;
                    } else {
                        break;
                    }
                } while (textWidth > labelWidth * 0.9 && fontSize > 8);
                
                doc.setFontSize(fontSize);
                doc.text(label.nombre, marginLeft + labelWidth / 2, nombreY, { 
                    align: 'center', 
                    maxWidth: labelWidth * 0.9 
                });
                currentY += nombreHeight;
                
                // 3. Código de barras (si tiene clave)
                if (hasKey) {
                    const barcodeY = currentY + sectionHeights.barcode / 2;
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    // Usar fuente que soporte código de barras (texto especial)
                    doc.text(`*${label.clave}*`, marginLeft + labelWidth / 2, barcodeY, { align: 'center' });
                    currentY += sectionHeights.barcode;
                    
                    // 4. Clave (debajo del código de barras)
                    const claveY = currentY + sectionHeights.clave / 2;
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text(label.clave, marginLeft + labelWidth / 2, claveY, { align: 'center' });
                    currentY += sectionHeights.clave;
                }
                
                // 5. Piezas (al lado del código de barras, si tiene)
                if (hasPieces) {
                    const piecesY = labelY + sectionHeights.blanco / 2 + sectionHeights.asterisco + 
                                  nombreHeight + sectionHeights.barcode / 2;
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    const piecesText = `${label.piezaActual} de ${label.totalPiezas}`;
                    doc.text(piecesText, marginLeft + labelWidth - 1.0, piecesY, { align: 'right' });
                }
                
                // Dibujar línea punteada solo en el medio de la página (entre etiquetas)
                if (labelIndex % 2 === 0 && labelIndex + 1 < labels.length) {
                    const lineY = labelY + labelHeight;
                    doc.setDrawColor(200, 200, 200);
                    doc.setLineWidth(0.01);
                    const dashPattern = [0.2, 0.2];
                    doc.setLineDashPattern(dashPattern, 0);
                    doc.line(marginLeft, lineY, marginLeft + labelWidth, lineY);
                    doc.setLineDashPattern([], 0);
                }
                
                labelIndex++;
            }
            
            // Guardar PDF con nombre apropiado
            let filename = '';
            switch(type) {
                case 'withKeyMultiple':
                    filename = 'etiquetas_muebles_con_clave_varias_piezas.pdf';
                    break;
                case 'withKeySingle':
                    filename = 'etiquetas_muebles_con_clave_una_pieza.pdf';
                    break;
                case 'withoutKeyMultiple':
                    filename = 'etiquetas_muebles_sin_clave_varias_piezas.pdf';
                    break;
                case 'withoutKeySingle':
                    filename = 'etiquetas_muebles_sin_clave_una_pieza.pdf';
                    break;
            }
            
            doc.save(filename);
        }
    </script>
</body>
</html>